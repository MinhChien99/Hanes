<!DOCTYPE html>
<html lang="en" dir="ltr">
    <header>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <!-- <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-purple.min.css"> -->
        <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.purple-indigo.min.css" />
        <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
        <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/JS/getmdl/getmdl-select.min.css"/>
        <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
        <script defer src="/JS/getmdl/getmdl-select.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
        <title>Purchasing Order</title>
    </header>
    <body style="background-color: #E5E7E9;">
        <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
            <header class="mdl-layout__header">
                <div class="mdl-layout__header-row">
                    <!-- Title -->
                    <span class="mdl-layout-title">TẠO PURCHASING ORDER</span>
                    <div class="mdl-layout-spacer"></div>
                    <div id="div_cbb_month" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height" 
                        style="width: 100px; margin-left: 10px;">
                        <input type="text" value="" class="mdl-textfield__input" id="cbb_month" readonly>
                        <input type="hidden" value="" name="cbb_month">
                        <label for="cbb_month" class="mdl-textfield__label" style="color:white">Tháng</label>
                        <ul for="cbb_month" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-shadow--8dp" id="list_cbb_month">
                            <li class="mdl-menu__item" data-val="01">01</li>
                            <li class="mdl-menu__item" data-val="02">02</li>
                            <li class="mdl-menu__item" data-val="03">03</li>
                            <li class="mdl-menu__item" data-val="04">04</li>
                            <li class="mdl-menu__item" data-val="05">05</li>
                            <li class="mdl-menu__item" data-val="06">06</li>
                            <li class="mdl-menu__item" data-val="07">07</li>
                            <li class="mdl-menu__item" data-val="08">08</li>
                            <li class="mdl-menu__item" data-val="09">09</li>
                            <li class="mdl-menu__item" data-val="10">10</li>
                            <li class="mdl-menu__item" data-val="11">11</li>
                            <li class="mdl-menu__item" data-val="12">12</li>
                        </ul>
                    </div>
                    <div id="div_cbb_year" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height" 
                        style="width: 100px; margin-left: 10px;">
                        <input type="text" value="" class="mdl-textfield__input" id="cbb_year" readonly>
                        <input type="hidden" value="" name="cbb_year">
                        <label for="cbb_year" class="mdl-textfield__label" style="color:white">Năm</label>
                        <ul for="cbb_year" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-shadow--8dp" id="list_cbb_year">
                            <li class="mdl-menu__item" data-val="2020">2020</li>
                            <li class="mdl-menu__item" data-val="2021">2021</li>
                            <li class="mdl-menu__item" data-val="2022">2022</li>
                            <li class="mdl-menu__item" data-val="2023">2023</li>
                        </ul>
                    </div>
                </div>
                <!-- Tabs -->
            </header>
            <%- include ("../partials/navTemplate.ejs"); -%>
            <main class="mdl-layout__content">
                <div class="page-content">
                    <table class="mdl-data-table mdl-js-data-table mdl-shadow--6dp" style="border: none; width: 90%; margin: 10px auto;">
                        <thead style="background-color: indigo;">
                            <tr style=" height: 60px;">
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">STT</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">PO CODE</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">SỐ ITEM</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">DỰ ÁN</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">TỔNG TIỀN</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">TIỀN TỆ</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">TÀI KHOẢN</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">TÌNH TRẠNG</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="table_body_PO">
                        </tbody>
                    </table>
                </div>
                <button class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored" id="btn_new_PO" style="position: absolute; bottom: 50px; right: 50px; background-color: green;">
                    <i class="material-icons">add</i>
                </button>
                <div class="mdl-tooltip" for="btn_new_PO">Create PO</div>
            </main>
        </div>
    </body>
    <dialog>
        <div class="mdl-grid mdl-shadow--6dp" style="margin: 10px auto; width: 90%; background-color: white;">
            <div class="mdl-grid" style="width: 100%;">
                <h4 style="margin: 10px auto;" id="txt_PO_ID">PO_IE202021217_DULE4_084901</h4>
            </div>
            <div class="mdl-grid">
                <div class="mdl-cell mdl-cell--5-col">
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                        <input class="mdl-textfield__input" type="text" id="txt_po_project" style="color: black;">
                        <label class="mdl-textfield__label" for="txt_po_project">Project</label>
                    </div>
                    
                </div>
                <div class="mdl-cell mdl-cell--5-col"></div>
            </div>
            <table class="mdl-data-table mdl-js-data-table mdl-shadow--6dp" style="border: none; width: 90%; margin: 10px auto;">
                <thead style="background-color: indigo;">
                    <tr style=" height: 60px;">
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">STT</th>
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">PR CODE</th>
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">ITEM</th>
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">ĐƠN GIÁ</th>
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">TIỀN TỆ</th>
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">VENDOR</th>
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">LEADTIME</th>
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">EXPIRED</th>
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">TÌNH TRẠNG</th>
                        <th class="mdl-data-table__cell--non-numeric" style="color: white;">ACTION</th>
                    </tr>
                </thead>
                <tbody id="table_body_PO_temp">
                </tbody>
            </table>
        </div>
    </dialog>
    <dialog style="border-radius: 10px; border: none; padding: 0; background-color: transparent;" id="dialog_add_PO">
        <div class="demo-card-wide mdl-card mdl-shadow--2dp" style="width: 400px; border-radius: 10px;">
            <div class="mdl-card__title" style="background-color: indigo; color: white; ">
                <h3 class="mdl-card__title-text" id="txt_PO_ID_new"></h3>
                    <!-- <div id="txt_PO_ID"></div>
                </h2> -->
            </div>
            <div class="mdl-card__supporting-text" style=" height: 200px;">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="txt_PO_project" style="color: black;">
                    <label class="mdl-textfield__label" for="txt_PO_project">Tên Dự án</label>
                </div>
                <div id="div_cbb_count" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height" 
                    style="width: 200px;">
                    <input type="text" value="" class="mdl-textfield__input" id="cbb_account" readonly>
                    <input type="hidden" value="" name="cbb_account">
                    <label for="cbb_account" class="mdl-textfield__label">Tài khoản</label>
                    <ul for="cbb_account" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-shadow--8dp" id="list_cbb_account" style="height:100px;">
                        <li class="mdl-menu__item" data-val="HR">546500 0000 90IE</li>
                        <li class="mdl-menu__item" data-val="IE">560542 0000 90IE</li>
                        <li class="mdl-menu__item" data-val="FI">560545 0000 90IE</li>
                        <li class="mdl-menu__item" data-val="CT">561020 0000 90IE</li>
                        <li class="mdl-menu__item" data-val="CL">565200 0000 90IE</li>
                        <li class="mdl-menu__item" data-val="PR">565200 0000 98IE</li>
                    </ul>
                </div>
                <div id="div_cbb_PO_month" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height" 
                    style="width: 100px;">
                    <input type="text" value="" class="mdl-textfield__input" id="cbb_PO_month" readonly>
                    <input type="hidden" value="" name="cbb_PO_month">
                    <label for="cbb_PO_month" class="mdl-textfield__label">Tháng về</label>
                    <ul for="cbb_PO_month" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-shadow--8dp" id="list_cbb_PO_month" style="height:100px;">
                        <li class="mdl-menu__item" data-val="01">01</li>
                        <li class="mdl-menu__item" data-val="02">02</li>
                        <li class="mdl-menu__item" data-val="03">03</li>
                        <li class="mdl-menu__item" data-val="04">04</li>
                        <li class="mdl-menu__item" data-val="05">05</li>
                        <li class="mdl-menu__item" data-val="06">06</li>
                        <li class="mdl-menu__item" data-val="07">07</li>
                        <li class="mdl-menu__item" data-val="08">08</li>
                        <li class="mdl-menu__item" data-val="09">09</li>
                        <li class="mdl-menu__item" data-val="10">10</li>
                        <li class="mdl-menu__item" data-val="11">11</li>
                        <li class="mdl-menu__item" data-val="12">12</li>
                    </ul>
                </div>
            </div>
            <div class="mdl-card__actions mdl-card--border">
                <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="btn_add_done">
                    <i class="material-icons">done</i>
                    TẠO MỚI
                </button>
            </div>
            <div class="mdl-card__menu">
                <button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="btn_add_close" style="background-color: red; color: white;">
                    <i class="material-icons">close</i>
                </button>
            </div>
        </div>
    </dialog>
    <script>
        table_body_PO=document.getElementById('table_body_PO');
        var tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
        var localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, -1).substring(0,10);
        var rawTime=(new Date(Date.now() - tzoffset)).toISOString().slice(0, -1);
        function init_month_year(){
            var tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
            var localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, -1);
            var month=localISOTime.substring(5, 7);
            var year=localISOTime.substring(0,4);
            $('ul[for="cbb_month"] li[data-val="'+month+'"]').attr('data-selected',true); 
            $('ul[for="cbb_year"] li[data-val="'+year+'"]').attr('data-selected',true); 
            // get_employee_infor(month, quater, year);
            load_order_PO(month, year);
        }
        init_month_year();
        function load_order_PO(month, year){
            var xsend= new XMLHttpRequest();
            xsend.open("POST","/CCS/Get_Order_PO",true);
            xsend.onreadystatechange= function(){
                if (this.readyState==4 && this.status==200){
                    data=JSON.parse(xsend.responseText);
                    console.log(data)
                    while (table_body_PO.childNodes.length>0)
                    table_body_PO.removeChild(table_body_PO.childNodes[0]);
                    for (var i=0; i<data.length; i++){
                        var tr=document.createElement("tr");
                        //stt
                        var tdSTT=document.createElement("td");
                        tdSTT.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(i+1);
                        tdSTT.appendChild(node);
                        tr.appendChild(tdSTT);
                        //Item name
                        var tdItem=document.createElement("td");
                        tdItem.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].OrderID);
                        tdItem.appendChild(node);
                        tr.appendChild(tdItem);
                        //tdUnit
                        var tdUnit=document.createElement("td");
                        tdUnit.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].Items);
                        tdUnit.appendChild(node);
                        tr.appendChild(tdUnit);
                        //tdUnit
                        var tdUnit=document.createElement("td");
                        tdUnit.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].Project);
                        tdUnit.appendChild(node);
                        tr.appendChild(tdUnit);
                        //tdUnit
                        var tdUnit=document.createElement("td");
                        tdUnit.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].Total);
                        tdUnit.appendChild(node);
                        tr.appendChild(tdUnit);
                        //tdUnit
                        var tdUnit=document.createElement("td");
                        tdUnit.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].Currency);
                        tdUnit.appendChild(node);
                        tr.appendChild(tdUnit);
                        //tdUnit
                        var tdUnit=document.createElement("td");
                        tdUnit.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].Account);
                        tdUnit.appendChild(node);
                        tr.appendChild(tdUnit);
                        // //tdEs
                        // var tdEs=document.createElement("td");
                        // tdEs.setAttribute("class","mdl-data-table__cell--non-numeric");
                        // var timeUpdate=(new Date(data[i].Estimated)).toLocaleString("en-US", {timeZone: "Asia/Bangkok"}).split(',')[0];
                        // var node=document.createTextNode(timeUpdate);
                        // tdEs.appendChild(node);
                        // tr.appendChild(tdEs)
                        //tdQuan
                        var tdQuan=document.createElement("td");
                        tdQuan.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].PO_Status);
                        tdQuan.appendChild(node);
                        tr.appendChild(tdQuan);
                        //btn more
                        var tdMore=document.createElement("td");
                        tdMore.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var div=document.createElement("div");
                        var button=document.createElement("button");
                        button.setAttribute("class", "mdl-button mdl-js-button mdl-button--icon");
                        button.setAttribute("id", "button_more_rq"+i);
                        // button.setAttribute("onclick", "attach_file_download(this)");
                        var icon=document.createElement("i");
                        icon.setAttribute("class", "material-icons");
                        icon.innerHTML="more_vert";
                        componentHandler.upgradeElement(icon);
                        button.appendChild(icon);
                        componentHandler.upgradeElement(button);
                        var ul=document.createElement("ul");
                        ul.setAttribute("class", "mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect");
                        ul.setAttribute("for", "button_more_rq"+i);
                        // ul.setAttribute("style", "overflow: visible")
                        var li1=document.createElement("li");
                        li1.setAttribute("class", "mdl-menu__item");
                        li1.setAttribute("onclick", "function_detail_rq(this)");
                        li1.innerHTML="<i class='material-icons' style='vertical-align: middle; margin-right:10px; color: green'>insert_comment</i>Chi tiết";
                        var li2=document.createElement("li");
                        li2.setAttribute("class", "mdl-menu__item");
                        
                        li2.innerHTML="<i class='material-icons' style='vertical-align: middle; margin-right:10px; color: indigo'>send</i>Đặt hàng";
                        var li3=document.createElement("li");
                        li3.setAttribute("class", "mdl-menu__item");
                        
                        li3.innerHTML="<i class='material-icons' style='vertical-align: middle; margin-right:10px; color: red'>delete</i>Xóa";
                        // if (data[i].PO_Status=='Process') {
                        //     li3.setAttribute("onclick", "delete_request(this)");
                        //     li2.setAttribute("onclick", "send_request(this)");
                        // } else {
                        //     li2.setAttribute('disabled', true);
                        //     li3.setAttribute('disabled', true);
                        // }
                        // var li3=document.createElement("li");
                        // li3.setAttribute("class", "mdl-menu__item");
                        // li3.setAttribute("onclick", "remove_kaizen(this)");
                        // li3.innerHTML="<i class='material-icons' style='vertical-align: middle; margin-right:10px; color: red'>delete</i>Remove";
                        componentHandler.upgradeElement(li1);
                        componentHandler.upgradeElement(li2);
                        componentHandler.upgradeElement(li3);
                        ul.appendChild(li1);
                        ul.appendChild(li2);
                        ul.appendChild(li3);
                        tdMore.appendChild(button);
                        tdMore.appendChild(ul);
                        tr.appendChild(tdMore);
                        table_body_PO.appendChild(tr);
                        componentHandler.upgradeElement(tr);
                        componentHandler.upgradeDom('MaterialMenu', 'mdl-menu');
                    }
                }
            }
            // month=document.getElementById('cbb_month').value;
            // year=document.getElementById('cbb_year').value;
            xsend.setRequestHeader("Content-type", "application/json");
            data={month: month, year: year}
            console.log(data)
            xsend.send(JSON.stringify(data));
        }
        // document.getElementById('btn_new_PO').addEventListener('click', function(){
            
        // });
        document.getElementById('btn_add_close').addEventListener('click', function(){
            document.getElementById('dialog_add_PO').close();
        });
        document.getElementById('btn_new_PO').addEventListener('click', function(){
            var xsend= new XMLHttpRequest();
            xsend.open("POST","/Get_User_Infor",true);
            xsend.onreadystatechange= function(){
                if (this.readyState==4 && this.status==200){
                    data=JSON.parse(xsend.responseText);
                    if (data.length>0){
                        dept  = data[0].Department;
                        year  = localISOTime.split('-')[0];
                        month = localISOTime.split('-')[1];
                        day   = localISOTime.split('-')[2];
                        hh    = rawTime.split('T')[1].split(':')[0];
                        mm    = rawTime.split('T')[1].split(':')[1];
                        ss    = rawTime.split('T')[1].split(':')[2].split('.')[0];
                        user  = data[0].User.toUpperCase();
                        requestID=dept+year+month+day+'_'+user+'_'+hh+mm+ss;
                        // load_request_item_temp(requestID);
                        document.getElementById('txt_PO_ID_new').innerHTML=requestID;
                        console.log(requestID)
                        document.getElementById('dialog_add_PO').showModal();
                    }
                }
            }
            xsend.setRequestHeader("Content-type", "application/json");
            xsend.send();
        });
        document.getElementById('btn_add_done').addEventListener('click', function(){

        });
    </script>
</html>